"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var os=_interopDefault(require("os")),net=_interopDefault(require("net")),process=_interopDefault(require("process"));var serve=e=>net.createServer(e);const echo=e=>{e.pipe(e)};const fwd=(e,t,r)=>{const n=net.createConnection({host:t,port:r});n.pipe(e),e.pipe(n)},p=e=>/^\d{1,5}$/.test(e),port=process.env.PORT||80,sslport=process.env.SSLPORT||443,echoport=process.env.ECHOPORT,forward_host=process.env.FORWARD_HOST,forward_port=process.env.FORWARD_PORT;if(p(echoport))serve(echo).listen(echoport);else if(forward_host&&p(forward_port))serve(fwd).listen(port);else{serve(e=>{e.once("data",t=>{let r,n;if((e=>{if(e.length<5)return!1;if(22!==e[0])return!1;const t=e[1],r=e[2];if(3!==t)return!1;if(r<1||r>3)return!1;const n=e[3]<<8|e[4];return!(e.length<5+n)&&1===e[5]})(t))r=(e=>{let t=e.length,r=43;if(r>t-1)return null;if((r+=1+e[r])>t-2)return null;if((r+=2+(e[r]<<8|e[r+1]))>t-1)return null;if((r+=1+e[r])>t-2)return null;let n=e[r]<<8|e[r+1],o=(r+=2)+n;if(o>t)return null;for(t=o;r<=t-4;){let n=e[r]<<8|e[r+1],o=e[r+2]<<8|e[r+3];if(r+=4,0===n){if(r>t-2)return null;let n=e[r]<<8|e[r+1],o=r+=2;if((r+=n)>t)return null;for(;o<r-3;){let r=e[o],n=e[o+1]<<8|e[o+2];if(o+=3,0===r)return o>t-n?null:e.toString("ascii",o,o+n);o+=n}}else r+=o}return null})(t),n=sslport;else{const e=(e=>{const t=e.toString().split(os.EOL),r=t.length;for(let e=0;e<r;e++){const[r,n,o]=t[e].split(":",3);if("host"==r.toLowerCase())return{host:n.trim(),port:o||80}}return{}})(t);r=e.host,n=e.port}r?((e,t,r,n)=>{const o=net.createConnection({host:r,port:n});o.write(t,()=>{o.pipe(e),e.pipe(o)})})(e,t,r,n):e.write(t,()=>{e.pipe(e)})})}).listen(port)}